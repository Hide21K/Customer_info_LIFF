<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>登録フォーム（LIFF）</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; margin: 0; padding: 24px; }
    .card { max-width: 560px; margin: 0 auto; padding: 20px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.08); background: #fff; }
    h1 { font-size: 1.25rem; margin: 0 0 16px; }
    label { display:block; font-size:.95rem; margin:14px 0 6px; }
    input { width:100%; padding:12px 14px; border:1px solid #d0d7de; border-radius:10px; font-size:1rem; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    button { width:100%; margin-top:18px; padding:14px 16px; font-size:1rem; border:none; border-radius:12px; background:#06c755; color:#fff; font-weight:700; cursor:pointer; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .note { font-size:.85rem; color:#6b7280; margin-top:10px; }
    .error { color:#b91c1c; font-size:.9rem; margin-top:8px; }
    .success { color:#065f46; font-size:.95rem; margin-top:10px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ご登録フォーム</h1>

    <label for="name">氏名</label>
    <input id="name" type="text" placeholder="山田 太郎" autocomplete="name" />

    <div class="row">
      <div>
        <label for="phone">電話番号</label>
        <input id="phone" type="tel" placeholder="09012345678" inputmode="numeric" />
      </div>
      <div>
        <label for="date">投与日</label>
        <input id="date" type="date" />
      </div>
    </div>

    <button id="sendBtn">送信</button>
    <div id="msg" class="note">送信すると、次の形式でLINEに投稿されます：<br>
      <code>登録\n氏名：... \n電話：... \n投与日：...</code>
    </div>
    <div id="status" class=""></div>
  </div>

  <script>
    // ← ここをあなたのLIFF IDに置き換えてください
    const LIFF_ID = 'YOUR_LIFF_ID_HERE';

    const $ = (sel) => document.querySelector(sel);
    const nameEl = $('#name');
    const phoneEl = $('#phone');
    const dateEl = $('#date');
    const sendBtn = $('#sendBtn');
    const statusEl = $('#status');

    // 軽いバリデーション
    function validate() {
      const name = nameEl.value.trim();
      const phone = phoneEl.value.replace(/[^\d+]/g, '').trim();
      const date = dateEl.value; // yyyy-mm-dd
      const errs = [];
      if (!name) errs.push('氏名を入力してください。');
      if (!phone || !/^\d{10,11}$/.test(phone) && !/^\+?\d{8,15}$/.test(phone)) {
        errs.push('電話番号を正しく入力してください（ハイフン無し）。');
      }
      if (!date) errs.push('投与日を選択してください。');

      if (errs.length) {
        statusEl.className = 'error';
        statusEl.textContent = errs.join(' ');
        return null;
      }
      statusEl.className = '';
      statusEl.textContent = '';
      return { name, phone, date };
    }

    // yyyy-mm-dd → yyyy/MM/dd 表示に
    function formatDateSlash(ymd) {
      if (!ymd) return '';
      const [y,m,d] = ymd.split('-');
      return `${y}/${m}/${d}`;
    }

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          // LIFF内で未ログインならログイン
          liff.login();
          return;
        }

        // LIFFコンテキストに応じて送信可否をチェック
        // chat_message.write が有効で、かつトーク内/外でも sendMessages は呼べます（外部ブラウザの場合は権限必須）
        // ここではボタンを活性にしておく
        sendBtn.disabled = false;

        // 送信処理
        sendBtn.addEventListener('click', async () => {
          const v = validate();
          if (!v) return;

          // 送信テキストを組み立て
          // 電話番号はユーザーの入力そのまま（+81変換はしません：ご要望に合わせてそのまま送信）
          const message =
            `登録\n` +
            `氏名：${v.name}\n` +
            `電話：${v.phone}\n` +
            `投与日：${formatDateSlash(v.date)}`;

          try {
            sendBtn.disabled = true;
            statusEl.className = '';
            statusEl.textContent = '送信中…';

            await liff.sendMessages([
              { type: 'text', text: message }
            ]);

            statusEl.className = 'success';
            statusEl.textContent = '送信しました。画面を閉じても大丈夫です。';

            // トーク画面に戻す（LIFFブラウザの場合）
            if (liff.isInClient()) {
              setTimeout(() => liff.closeWindow(), 800);
            }
          } catch (err) {
            console.error(err);
            statusEl.className = 'error';
            statusEl.textContent = '送信に失敗しました。設定（権限/友だち追加/LIFF ID）をご確認ください。';
          } finally {
            sendBtn.disabled = false;
          }
        });

      } catch (e) {
        console.error('LIFF init error:', e);
        statusEl.className = 'error';
        statusEl.textContent = 'LIFFの初期化に失敗しました。LIFF IDやドメイン設定を確認してください。';
      }
    }

    main();
  </script>
</body>
</html>
